# Creating Build Node

The build node can be used to create SD cards for the infra gateway along with images.  The gateway will be a firewall + caching proxy + netboot server.  The build node will have some development tools installed, and can be a desktop.

First install ubuntu onto the SD Card using the [Raspberry Pi Imager](https://www.raspberrypi.com/software).  Choose "Other general-purpose OS" then "Ubuntu" then the latest "Ubuntu Server" or "Ubuntu Desktop" LTS, which will work on a number of Raspberry Pis.

Boot the Pi with the new card, using "ubuntu/ubuntu", please give it an extra minute after the login prompt for cloud-init to complete and create the user.  Use SSH might work if the IP can be determined from the DHCP server to avoid requiring a monitor+keyboard (if can determine the IP address, the hostname will be ubuntu).

After SSH-ing in and changing the default password, add a .pub SSH key for convenience, the type "ed25519" is OK (in 2022).

Copy the build-node scripts over to the build node using scp.  These scripts are generated by rundoc and are committed into the repo so the local machine does not require rundoc.

```
BUILD_NODE=build-node.local
scp build-node build-node-ip:
```

Update vars.sh on the build node before running setup.sh:

```
./setup.sh
```

setup.sh will run a series of scripts:

```create-file:build-node/setup.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
cd build-node
. upgrade.sh
. packages.sh
. python-packages.sh
. download-ubuntu.sh
. verify-device.sh
. unpack-ubuntu-onto-device.sh
. mount-ubuntu-from-device.sh
. copy-files.sh
. unmount.sh
```

## Prepare Build Node

The first script is upgrade.sh, it updates the package cache, upgrades the system. Note: security updates will no longer be automatically applied.

```create-file:build-node/upgrade.sh
#!/bin/bash
# created by README-build-node.md
set -e
sudo apt remove unattended-upgrades
sudo apt update
sudo apt upgrade -y
```

Then packages.sh will install ubuntu packages and snaps in packages.sh
```create-file:build-node/packages.sh
#!/bin/bash
# created by README-build-node.md
set -e
sudo apt install -y silversearcher-ag 
sudo snap install --classic nvim go
```

Then python packages will be installed in python-packages.sh

```create-file:build-node/python-packages.sh
#!/bin/bash
# created by README-build-node.md
set -e
pip3 install -u rundoc
```

These vars can be edited, they will be included by other scripts
```create-file:build-node/vars.sh
DEVICE=
WIFI_SSID=
WIFI_PASSWORD=
UBUNTU_VERSION=22.04
UBUNTU_PATCH_VERSION=1
```

## Download Images

Then pull ubuntu preinstalled server, which is a compacted complete disk image

```create-file:build-node/download-ubuntu.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
wget --no-clobber http://cdimage.ubuntu.com/releases/${UBUNTU_VERSION}/release/ubuntu-${UBUNTU_VERSION}.${UBUNTU_PATCH_VERSION}-preinstalled-desktop-arm64+raspi.img.xz
```

## Verify SD Card

Find SD Card (check is for USB devices: not generic, sorry), and verify no filesystems are on the card.

```create-file:build-node/verify-device.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
if [[ "${DEVICE:-}" == "" ]]; then
    DEVICES="$(ls /sys/bus/usb/devices/*/*/host*/target*/*/block)"
    echo -e "\nFound devices: $DEVICES\n"
    echo -e "usage: env DEVICE=<device name e.g. sdb> $0\n"
    exit 1
fi

foundParts=$(lsblk -J "/dev/$DEVICE" )
if [[ "$foundParts" == "" ]]; then
    echo Device $DEVICE is not available
    exit 1
fi

foundPartsCount=$(echo "$foundParts" | jq -r ".blockdevices[].children|length")
if [[ "$foundPartsCount" != "0" ]]; then
  echo -e "Found filesystems, please umount filesystems and clear SD card partition table:\n$(lsblk --fs /dev/"$DEVICE")"
  echo -e "\nThis command will wipe the partition table:"
  echo -e "sudo dd if=/dev/zero of=\"/dev/$DEVICE\" bs=1M count=5\n" 
  exit 1
fi
```

## Install and Mount Ubuntu on SD Card

Unpack ubuntu onto the selected device

```create-file:build-node/unpack-ubuntu-onto-device.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
xzcat --stdout ubuntu-18.04.4-preinstalled-server-armhf+raspi3.img.xz | pv | sudo dd of=/dev/$DEVICE bs=1M
sudo partprobe
```

Mount the boot and root ubuntu partitions from the device
```create-file:build-node/mount-ubuntu-from-device.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
PIROOT=/media/$USER/piroot
sudo mkdir -p /media/$USER/piboot "$PIROOT"
sudo mount /dev/${DEVICE}1 /media/$USER/piboot
sudo mount /dev/${DEVICE}2 "$PIROOT"
```

## Create Ubuntu and cloud-init configuration for SD Card

### Networking configuration for build-node Ubuntu
Set up interfaces.  `eth0` is connected to external network, while the pocket network will be on USB on `eth1`, raspberry pi 4 would have much better network speeds than earlier versions over USB (~300Mbit for USB 3.0).

The faster connection is used for external network to allow for the gateway to also be used as home internet gateway.

Interface for external network as DHCP
```create-file:build-node/eth0.yaml
# created by README-build-node.md
network:
    version: 2
    renderer: networkd
    ethernets:
        eth1:
            optional: true
            dhcp4: true
            # do not release IP address
            critical: true
            link-local: [ipv4]
```

Wireless network for external interface, assumes that vars.sh was updated with WIFI SSID and password.

```r-create-file:build-node/wlan0.yaml
# created by README-build-node.md
network:
    version: 2
    renderer: networkd
    wifis:
        wlan0:
            # allow OS to start (while still building boot sequeuence)
            optional: true
            # do not release IP address
            critical: true
            dhcp4: true
            access-points:
                "%:WIFI_SSID:%":
                    password: "%:WIFI_PASSWORD:%"
```

Avoid cloud init from conflicting from our manual setup of netplan
```create-file:build-node/cloud-init-disable-network-config.cfg
# created by README-build-node.md
network: {config: disabled}
```

Set the hostname

```create-file:build-node/cloud-init-hostname.cfg
# created by README-build-node.md
hostname: gw
```


### SSH

Add ssh keys to a cloud init configuration file

```bash
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
if ! ls ~/.ssh/id_*.pub; then
  echo No ssh keys in ~/.ssh
fi

pushd build-node
echo "ssh_authorized_keys:" | tee ssh_authorized_keys.cfg 2>/dev/null
for f in $(ls ~/.ssh/id_*.pub); do
  echo "  - $(cat $f)" | tee -a ssh_authorized_keys.cfg 2>/dev/null
done
popd
```

### Ubuntu Packages on SD Card

```create-file:build-node/cloud-init-packages.cfg
packages:
  - rng-tools
  - make
  - gcc
  - iptables-persistent
  - netfilter-persistent
```

## IP Forwarding Config for build-node

This is not firewalling, it's just forwarding packets with NAT currently.

NAT the forwarded packets, and zero out filtering
```r-create-file:build-node/rules.v4
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -o eth0 -j MASQUERADE
-A POSTROUTING -o wlan0 -j MASQUERADE
COMMIT
```

Tell kernel it is OK to forward packets with config to go in /etc/sysctl.d/99--forwarding.conf
```r-create-file:build-node/forwarding.conf
net.ipv4.ip_forward=1
```

## Copy files to SD Card
```r-create-file:build-node/copy-files.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail

PIROOT=/media/$USER/piroot

pushd "$PIROOT"/etc/netplan
sudo cp ~1/{wlan0,eth{0,1}}.yaml .
popd

pushd "$PIROOT"/etc/cloud/cloud.cfg.d
sudo cp ~1/cloud-init-disable-network-config.cfg 99-disable-network-config.cfg
sudo cp ~1/ssh_authorized_keys.cfg 99-ssh_authorized_keys.cfg
sudo cp ~1/cloud-init-packages.cfg 99-packages.cfg
popd

pushd $PIROOT/etc
sudo cp ~1/resolved.conf systemd/resolved.conf
sudo cp ~1/cloud-init-hostname.cfg cloud/cloud.cfg.d/99-hostname.cfg
sudo mkdir -p iptables
sudo cp ~1/rules.v4 iptables/
popd

pushd "$PIROOT"/etc/sysctl.d
sudo cp ~1/forwarding.conf 99-forwarding.conf
popd

mkdir /var/cache/images
sudo cp *raspi.img.xz "$PIROOT"/var/cache/images/
```

## Unmount SD Card

```r-create-file:build-node/unmount.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
sync
sudo umount /dev/${DEVICE}1 /dev/${DEVICE}2
sudo eject /dev/${DEVICE}

echo Completed!
```
