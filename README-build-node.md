# Creating Build Node

The build node can be used to create SD cards for the infra gateway along with images.  The gateway will be a firewall + caching proxy + netboot server.  The build node will have some development tools installed, and can be a desktop.

First install ubuntu onto the SD Card using the [Raspberry Pi Imager](https://www.raspberrypi.com/software).  Choose "Other general-purpose OS" then "Ubuntu" then the latest "Ubuntu Server" or "Ubuntu Desktop" LTS, which will work on a number of Raspberry Pis.

Boot the Pi with the new card, using "ubuntu/ubuntu", please give it an extra minute after the login prompt for cloud-init to complete and create the user.  Use SSH might work if the IP can be determined from the DHCP server to avoid requiring a monitor+keyboard (if can determine the IP address, the hostname will be ubuntu).

After SSH-ing in and changing the default password, add a .pub SSH key for convenience, the type "ed25519" is OK (in 2022).

Copy the build-node scripts over to the build node using scp.  These scripts are generated by rundoc and are committed into the repo so the local machine does not require rundoc.

```
BUILD_NODE=build-node.local
scp build-node build-node-ip:
```

Update vars.sh on the build node before running setup.sh:

```
./setup.sh
```

setup.sh will run a series of scripts:

```create-file:build-node/setup.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail
cd build-node
. upgrade.sh
. packages.sh
. python-packages.sh
. apply-config.sh
sudo systemctl reboot
```

## Prepare Build Node

The first script is upgrade.sh, it updates the package cache, upgrades the system. Note: security updates will no longer be automatically applied.

```create-file:build-node/upgrade.sh
#!/bin/bash
# created by README-build-node.md
set -e
sudo apt remove unattended-upgrades
sudo apt update
sudo apt upgrade -y
```

Then packages.sh will install ubuntu packages and snaps in packages.sh
```create-file:build-node/packages.sh
#!/bin/bash
# created by README-build-node.md
set -e
sudo apt install -y silversearcher-ag make gcc rng-tools
sudo snap install --classic nvim go
```

Then python packages will be installed in python-packages.sh

```create-file:build-node/python-packages.sh
#!/bin/bash
# created by README-build-node.md
set -e
pip3 install -u rundoc
```

These vars can be edited, they will be included by other scripts
```env
DEVICE=
WIFI_SSID=
WIFI_PASSWORD=
UBUNTU_VERSION=22.04
UBUNTU_PATCH_VERSION=1
```

## Create Ubuntu and cloud-init configuration for SD Card

### Networking configuration for build-node Ubuntu
Set up interfaces.  `eth0` is connected to external network, while the pocket network will be on USB on `eth1`, raspberry pi 4 would have much better network speeds than earlier versions over USB (~300Mbit for USB 3.0).

The faster connection is used for external network to allow for the gateway to also be used as home internet gateway.

Interface for external network as DHCP
```create-file:build-node/eth0.yaml
# created by README-build-node.md
network:
    version: 2
    renderer: networkd
    ethernets:
        eth1:
            optional: true
            dhcp4: true
            # do not release IP address
            critical: true
            link-local: [ipv4]
```

Wireless network for external interface, assumes that vars.sh was updated with WIFI SSID and password.

```r-create-file:build-node/wlan0.yaml
# created by README-build-node.md
network:
    version: 2
    renderer: networkd
    wifis:
        wlan0:
            # allow OS to start (while still building boot sequeuence)
            optional: true
            # do not release IP address
            critical: true
            dhcp4: true
            access-points:
                "%:WIFI_SSID:%":
                    password: "%:WIFI_PASSWORD:%"
```

Set the hostname

```create-file:build-node/hostname
# created by README-build-node.md
build-node
```


## Apply Configuration
```r-create-file:build-node/apply-config.sh
#!/bin/bash
# created by README-build-node.md
set -euo pipefail

if [[ "%:WIFI_SSID:%" != "" ]]; then
    sudo cp build-node/wlan0.yaml /etc/netplan/
fi
sudo cp build-node/{eth{0,1}}.yaml /etc/netplan/
sudo rm /etc/netplan/99-cloud-init.yaml
sudo cp build-node/hostname /etc/
```
